{% extends "layout/base.html" %}
{% block title %}{{ topic.title }}{% endblock %}
{% block page_title %}Konu: {{ topic.title }}{% endblock %}

{% block content %}
{% csrf_token %}

<div class="row">
  <div class="col-lg-7">
    <div class="card card-outline card-info">
      <div class="card-header">
        <h3 class="card-title mb-0"><i class="fas fa-photo-video"></i> İçerikler</h3>
      </div>
      <div class="card-body" id="contentArea">
        <p class="text-muted mb-0">Yükleniyor...</p>
      </div>
    </div>

    <div class="card card-outline card-success">
      <div class="card-header">
        <h3 class="card-title mb-0"><i class="fas fa-chart-line"></i> Durum</h3>
      </div>
      <div class="card-body" id="progressArea">
        <p class="text-muted mb-0">Yükleniyor...</p>
      </div>
    </div>
  </div>

  <div class="col-lg-5">
    <div class="card card-outline card-warning">
      <div class="card-header">
        <h3 class="card-title mb-0"><i class="fas fa-clipboard-check"></i> Mini Test</h3>
      </div>
      <div class="card-body" id="quizArea">
        <p class="text-muted mb-0">Yükleniyor...</p>
      </div>
    </div>
  </div>
</div>

<script>
const TOPIC_ID = {{ topic.id }};
let QUESTIONS = [];

function escapeHtml(s){
  return (s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}

function getCsrfToken(){
  const inp = document.querySelector('input[name="csrfmiddlewaretoken"]');
  return inp ? inp.value : "";
}

function renderProgress(p){
  if (!p) return `<div class="text-muted">Henüz ilerleme yok.</div>`;
  const v = p.video_progress ?? 0;
  const t = p.test_score ?? 0;
  const done = p.completed ? "✅ Tamamlandı" : "⏳ Devam ediyor";
  return `
    <div class="mb-2"><b>Video ilerleme:</b> %${v}</div>
    <div class="progress mb-3">
      <div class="progress-bar" role="progressbar" style="width:${v}%">${v}%</div>
    </div>
    <div class="mb-2"><b>Test puanı:</b> ${Number(t).toFixed(1)}</div>
    <div class="mb-2"><b>Durum:</b> ${done}</div>
  `;
}

function renderContents(contents){
  if (!contents || contents.length === 0){
    return `<div class="text-muted">Bu konuya içerik eklenmemiş.</div>`;
  }

  let html = "";
  for (const c of contents){
    if (c.type === "video"){
      html += `
        <div class="mb-4">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <b><i class="fas fa-film"></i> ${escapeHtml(c.title)}</b>
            <button class="btn btn-sm btn-success" onclick="markVideo80()">
              %80 İzledim
            </button>
          </div>

          ${c.file ? `
            <video controls style="width:100%; max-height:420px;">
              <source src="${c.file}" type="video/mp4">
            </video>
          ` : (c.url ? `
            <a class="btn btn-outline-primary btn-sm" href="${c.url}" target="_blank">Videoyu Aç</a>
          ` : `<div class="text-muted">Video kaynağı yok</div>`)}
        </div>
      `;
    } else if (c.type === "pdf"){
      html += `
        <div class="mb-3">
          <b><i class="fas fa-file-pdf"></i> ${escapeHtml(c.title)}</b><br/>
          ${c.file ? `<a class="btn btn-sm btn-primary mt-2" href="${c.file}" target="_blank">PDF Aç</a>` :
            (c.url ? `<a class="btn btn-sm btn-primary mt-2" href="${c.url}" target="_blank">PDF Aç</a>` :
            `<div class="text-muted">PDF kaynağı yok</div>`)}
        </div>
      `;
    } else {
      html += `<div class="mb-3"><b>${escapeHtml(c.title)}</b></div>`;
    }
  }
  return html;
}

function renderQuiz(questions){
  QUESTIONS = questions || [];
  if (QUESTIONS.length === 0){
    return `<div class="text-muted">Bu konuya soru eklenmemiş.</div>`;
  }

  let html = `<form id="quizForm">`;
  for (const q of QUESTIONS){
    html += `
      <div class="mb-3 p-2 border rounded">
        <div class="mb-2"><b>${escapeHtml(q.text)}</b></div>

        ${["A","B","C","D"].map(letter => {
          const key = letter.toLowerCase();
          const val = q[key];
          return `
            <div class="custom-control custom-radio">
              <input type="radio" id="q${q.id}_${letter}" name="q_${q.id}" value="${letter}" class="custom-control-input">
              <label class="custom-control-label" for="q${q.id}_${letter}">
                ${letter}) ${escapeHtml(val)}
              </label>
            </div>
          `;
        }).join("")}
      </div>
    `;
  }

  html += `
    <button type="submit" class="btn btn-warning btn-block">
      <i class="fas fa-paper-plane"></i> Testi Gönder
    </button>
    <div id="quizResult" class="mt-3"></div>
  </form>
  `;
  return html;
}

async function fetchTopic(){
  const res = await fetch(`/api/topics/${TOPIC_ID}`, {credentials:"same-origin"});
  const data = await res.json();

  document.getElementById("contentArea").innerHTML = renderContents(data.data.contents);
  document.getElementById("progressArea").innerHTML = renderProgress(data.data.progress);
  document.getElementById("quizArea").innerHTML = renderQuiz(data.data.questions);

  const form = document.getElementById("quizForm");
  if (form){
    form.addEventListener("submit", submitQuiz);
  }
}

async function markVideo80(){
  const csrf = getCsrfToken();
  await fetch(`/api/topics/${TOPIC_ID}/video-progress`, {
    method:"POST",
    credentials:"same-origin",
    headers: {"Content-Type":"application/json", "X-CSRFToken": csrf},
    body: JSON.stringify({progress: 80})
  });
  await fetchTopic();
}

async function submitQuiz(e){
  e.preventDefault();
  const csrf = getCsrfToken();

  const answers = [];
  for (const q of QUESTIONS){
    const checked = document.querySelector(`input[name="q_${q.id}"]:checked`);
    if (checked){
      answers.push({question_id: q.id, answer: checked.value});
    }
  }

  const res = await fetch(`/api/topics/${TOPIC_ID}/test-submit`, {
    method:"POST",
    credentials:"same-origin",
    headers: {"Content-Type":"application/json", "X-CSRFToken": csrf},
    body: JSON.stringify({answers})
  });

  const data = await res.json();
  const box = document.getElementById("quizResult");

  if (!data.ok){
    box.innerHTML = `<div class="alert alert-danger">Hata: ${escapeHtml(data.error || "Bilinmeyen")}</div>`;
    return;
  }

  box.innerHTML = `
    <div class="alert alert-info">
      <b>Sonuç:</b> ${data.data.correct}/${data.data.total}<br/>
      <b>Puan:</b> ${Number(data.data.score).toFixed(1)}<br/>
      <b>Durum:</b> ${data.data.completed ? "✅ Konu tamamlandı!" : "⏳ Devam"}
    </div>
  `;

  await fetchTopic();
}

fetchTopic();
</script>
{% endblock %}
